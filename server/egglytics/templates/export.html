{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Dataset Export</title>
    <link rel="stylesheet" href="{% static 'css/export.css' %}">
</head>
<body>
    <div class="container">
        <h2>Dataset Export Summary</h2>
    <form id="export-form">
            <div class="form-group">
                <label><strong>Select Model:</strong></label>
                <select id="model-select" name="model" class="custom-select">
                    <option value="">-- Select a model --</option>
                    {% for model in models %}
                        <option value="{{ model }}">{{ model }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label><strong>Date range:</strong></label>
                <div class="date-range">
                    <input type="date" id="dateFrom">
                    <span>-</span>
                    <input type="date" id="dateTo">
                </div>
            </div>

            <div class="form-group checkbox-group">
                <input type="checkbox" id="include_verified" checked>
                <label for="include_verified">Only download verified results</label>
            </div>
        </form>

        <hr>

        <div id="export-summary" class="dashboard-grid">
            <div class="model-card">
                <h3>Dataset Summary</h3>

                 <div class="metrics-list">
                    <div id="total_images">
                        Total Points: 0
                    </div>
                </div>

                <div class="metric-grid">
                    <div class="metric-card-small tp">
                        Points
                    </div>
                    <div class="metric-card-small fn">
                        Rectangles
                    </div>
                </div>
            </div>
        </div>

        <button id="export-btn">Download Dataset</button>
    </div>

<script>
function updateExportStats() {
    const model = document.getElementById("model-select").value;
    const verifiedCheckbox = document.getElementById("include_verified");
    const dateFrom = document.getElementById("dateFrom").value;
    const dateTo = document.getElementById("dateTo").value;

    if (!model) return;

    let params = new URLSearchParams({ model });

    if (verifiedCheckbox.checked) {
        params.append("verified", "1");
    }

    if (dateFrom) {
        params.append("date_from", dateFrom);
    }

    if (dateTo) {
        params.append("date_to", dateTo);
    }

    fetch(`/export/export_image_count/?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                console.error(data.error);
                return;
            }

            document.getElementById("total_images").textContent =
                "Total Images: " + data.total_images;
            
            document.getElementById("total_eggs_point").textContent = 
                "Total Eggs (Point): " + data.total_points;

            document.getElementById("total_eggs_rect").textContent = 
                "Total Eggs (Rect): " + data.total_rects;
            
        })
        .catch(err => console.error("Count error:", err));
}

// Runs ONLY when model changes
function updateDateRangeAndStats() {
    const model = document.getElementById("model-select").value;
    if (!model) return;

    fetch(`/export/date-range/?model=${encodeURIComponent(model)}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                console.error(data.error);
                return;
            }

            const dateFromInput = document.getElementById("dateFrom");
            const dateToInput = document.getElementById("dateTo");

            dateFromInput.min = data.dateFrom;
            dateFromInput.max = data.dateTo;
            dateToInput.min = data.dateFrom;
            dateToInput.max = data.dateTo;

            dateFromInput.value = data.dateFrom;
            dateToInput.value = data.dateTo;

            // After dates are set, update counts
            updateExportStats();
        })
        .catch(err => console.error("Date range error:", err));
}

/* -----------------------
   Event listeners
------------------------ */

// Model change → update date range + stats
document.getElementById("model-select")
    .addEventListener("change", updateDateRangeAndStats);

// Any filter change → update stats only
document.getElementById("include_verified")
    .addEventListener("change", updateExportStats);

document.getElementById("dateFrom")
    .addEventListener("change", updateExportStats);

document.getElementById("dateTo")
    .addEventListener("change", updateExportStats);

document.getElementById("export-btn").addEventListener("click", function () {
    const model = document.getElementById("model-select").value;
    const verified = document.getElementById("include_verified").checked;
    const dateFrom = document.getElementById("dateFrom").value;
    const dateTo = document.getElementById("dateTo").value;

    if (!model) {
        alert("Select a model first");
        return;
    }

    let params = new URLSearchParams({ model });

    if (verified) params.append("verified", "1");
    if (dateFrom) params.append("date_from", dateFrom);
    if (dateTo) params.append("date_to", dateTo);

    window.location.href = `/export/download/?${params.toString()}`;
});
</script>
</body>
</html>