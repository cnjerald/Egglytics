<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

        <title>Sample Info</title>
        <style>

            /* === Global Styles === */
            body {
                font-family: Arial, sans-serif;
                background-color: #f7f9fb;
                margin: 0;
                padding: 0;
                color: #333;
            }

            /* === Notice Box === */
            #notice-box {
                text-align: center;
                border: 2px solid #ccc;
                background-color: #BFDBF7;
                width: 80%;
                border-radius: 10px;
                margin: 1% auto;
                padding: 10px;
            }

            /* === Table Controls (Filters) === */
            .table-controls {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin: 15px auto;
                font-family: Arial, sans-serif;
                align-items: center;
            }

            .filter-group {
                display: flex;
                flex-wrap: wrap;
                gap: 15px;
                align-items: center;
                justify-content: center;
            }

            .filter-item {
                display: flex;
                align-items: center;
                gap: 5px;
                font-size: 14px;
            }

            .filter-item input {
                padding: 6px 10px;
                border: 1px solid #ccc;
                border-radius: 6px;
                font-size: 14px;
                outline: none;
                transition: border-color 0.2s ease;
            }

            .filter-item input:focus {
                border-color: #007bff;
                box-shadow: 0 0 4px rgba(0, 123, 255, 0.3);
            }

            /* === Main Table === */
            .table {
                width: 90%;
                border-collapse: collapse;
                font-family: Arial, sans-serif;
                margin: 20px auto;
                background-color: white;
                border-radius: 10px;
                overflow: hidden;
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            }

            .table th, .table td {
                border: 1px solid #e3e3e3;
                padding: 10px;
                text-align: center;
            }

            .table th {
                background-color: #f8f8f8;
                font-weight: bold;
                cursor: pointer;
                user-select: none;
                position: relative;
                transition: background-color 0.2s ease;
            }

            .table th:hover {
                background-color: #e2e2e2;
            }

            /* Sorting arrows */
            .table th::after {
                content: "\25B4\25BE";
                font-size: 0.7em;
                position: absolute;
                right: 8px;
                color: #999;
            }

            /* Row stripes + hover */
            .table tr:nth-child(even) {
                background-color: #fafafa;
            }
            .table tr:hover {
                background-color: #f1f1f1;
                cursor: pointer;
            }

            /* Delete button */
            .delete-btn {
                background: none;
                border: none;
                color: #dc3545;
                font-size: 18px;
                cursor: pointer;
                transition: color 0.2s ease, transform 0.2s ease;
            }
            .delete-btn:hover {
                color: #b02a37;
                transform: scale(1.1);
            }

            /* === Popup Modal === */
            .popup {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                justify-content: center;
                align-items: center;
                padding: 20px;
                z-index: 9999;
            }

            .popup-content {
                background: white;
                border-radius: 10px;
                width: 90vw;
                min-height: 60vh;
                padding: 50px;
                text-align: center;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                animation: popupFade 0.2s ease-in-out;
            }

            @keyframes popupFade {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            /* === Popup Layout === */
            .popup-holder {
                display: flex;
                gap: 20px;
                align-items: flex-start;
                justify-content: center;
                width: 100%;
                margin-top: 10px;
            }

            .half {
                flex: 1;
                min-width: 0; /* Prevents flex overflow */
            }

            .button-photo {
                max-width: 100%;
                max-height: 60vh;
                object-fit: contain;
                border-radius: 8px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            }

            .text-side {
                text-align: left;
                max-height: 60vh;
                overflow-y: auto;
                padding-right: 5px;
            }

            /* === Popup Table === */
            #popup-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 14px;
            }

            #popup-table th, #popup-table td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: center;
                cursor: pointer;
            }

            #popup-table th {
                background-color: #f9f9f9;
                cursor: pointer;
                position: relative;
            }

            #popup-table th.asc::after {
                content: " ▲";
                color: #666;
            }
            #popup-table th.desc::after {
                content: " ▼";
                color: #666;
            }

            #popup-table tr:nth-child(even) {
                background-color: #fafafa;
            }
            #popup-table tr:hover {
                background-color: #eef3ff;
            }

            /* === Close Button === */
            .close-btn {
                margin-top: 15px;
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                background: #007bff;
                color: white;
                cursor: pointer;
                transition: background 0.2s ease, transform 0.2s ease;
            }
            .close-btn:hover {
                background: #0056b3;
                transform: scale(1.05);
            }
            #batch-name-container {
                position: relative;
                display: inline-block;
            }

            #popup-batch-name-container {
                position: relative;
                display: inline-block;
                padding-right: 30px;
            }

            #edit-batch-btn {
                margin-left: 8px;
                padding: 2px 6px;
                font-size: 0.8em;
                cursor: pointer;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                display: none; /* hidden by default */
                position: absolute;
                top: 0;
                right: -5px; /* adjust distance */
                transition: background-color 0.2s;
                z-index: 10;
            }

            /* Make sure hovering anywhere inside container shows button */
            #popup-batch-name-container:hover #edit-batch-btn {
                display: inline-block;
            }

            #batch-name-edit-controls {
                display: inline-block;
                margin-left: 5px;
            }

            #batch-name-edit-controls button {
                padding: 2px 5px;
                margin-left: 2px;
                font-size: 0.8em;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            #batch-name-edit-controls .save-btn {
                background-color: #28a745;
                color: white;
            }

            #batch-name-edit-controls .cancel-btn {
                background-color: #dc3545;
                color: white;
            }




        </style>
    </head>
    <body>

        <div id="notice-box">

        </div>

        <div class="table-controls">
            <div class="filter-group">
                <input type="text" id="batchSearch" placeholder="Search Batch Name..." />

                <div class="filter-item">
                <label>Date Updated:</label>
                <input type="date" id="dateFrom"> -
                <input type="date" id="dateTo">
                </div>

                <div class="filter-item">
                <label>Total Images:</label>
                <input type="number" id="imagesMin" placeholder="Min" min="0"> -
                <input type="number" id="imagesMax" placeholder="Max" min="0">
                </div>

                <div class="filter-item">
                <label>Total Eggs:</label>
                <input type="number" id="eggsMin" placeholder="Min" min="0"> -
                <input type="number" id="eggsMax" placeholder="Max" min="0">
                </div>
            </div>
        </div>
        <table class="table" id="batchTable">
            <thead>
                <tr>
                    <th>Batch Name</th>
                    <th>Date Updated</th>
                    <th>Total Images</th>
                    <th>Total Eggs</th>
                    <th>Processing Status</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                {% for batch in batches %}
                <tr data-batch-id="{{ batch.id }}">
                    <td>{{ batch.batch_name }}</td>
                    <td>{{ batch.date_updated|date:"m/d/Y" }}</td>
                    <td>{{ batch.total_images }}</td>
                    <td>{{ batch.total_eggs }}</td>
                    <td>
                        {% if batch.has_fail_present %}
                            <i class="fas fa-exclamation-triangle" style="color: red;"></i>
                        {% elif batch.is_complete and not batch.has_fail_present %}
                            <i class="fas fa-check-circle" style="color: green;"></i>
                        {% else %}
                            <i class="fas fa-spinner fa-spin" style="color: orange;"></i>
                        {% endif %}
                    </td>
                    <td>
                        <button class="delete-btn" data-batch-id="{{ batch.id }}">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Popup Modal -->
        <div class="popup" id="popup">
        <div class="popup-content">
            <h3 id="popup-text">
                Image Details for: 
                <span id="popup-batch-name-container">
                    <span id="popup-batch-name"></span>
                    <button id="edit-batch-btn">
                        <i class="fas fa-edit"></i>
                    </button>
                </span>
            </h3>
            <div class="popup-holder">
            <div class="half">
                <img id="popup-image" src="" alt="Image Preview" class="button-photo">
            </div>
            <div class="half text-side">
                <table id="popup-table">
                <thead>
                    <tr>
                    <th data-column="image_name">Image</th>
                    <th data-column="total_eggs">Eggs</th>
                    <th data-column="total_hatched">Hatched</th>
                    <th data-column="img_type">Type</th>
                    <th>Edit</th>
                    <th>Delete</th> <!-- New column -->
                    </tr>
                </thead>
                <tbody id="popup-details">
                    <!-- JS will fill this -->
                </tbody>
                </table>
            </div>
            </div>
            <button class="close-btn" onclick="closePopup()">Close</button>
        </div>
        </div>




    </body>
    <script>
    $("#notice-box").hide();
    let flag = JSON.parse(localStorage.getItem("flag"));

    // Show notice if processing is active
    if (flag?.processingActive) {
        $("#notice-box").html(`
            <h5>
                Your images are being processed. The results are updated every 30 seconds.<br>
                Processing Status: <i class="fas fa-spinner fa-spin" style="color: orange;"></i>
            </h5>
        `).show();
    }

    // Periodic batch status update
    updateBatchStatus(); // immediate call
    setInterval(updateBatchStatus, 15000); // every 15 sec

    function updateBatchStatus() {
        fetch('/batch/status/latest/')
            .then(res => res.json())
            .then(batch => {
                if (!batch || !batch.id) {
                    $("#notice-box").html("<h5>No batches found</h5>").show();
                    return;
                }

                const row = document.querySelector(`#batchTable tbody tr[data-batch-id="${batch.id}"]`);
                if (row) {
                    const totalEggsCell = row.children[3]; // 4th column
                    totalEggsCell.textContent = batch.total_eggs;

                    const statusCell = row.children[4]; // 5th column
                    if (batch.is_complete && !batch.has_fail_present) {
                        statusCell.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i>';
                        if(flag?.processingActive){
                            $("#notice-box").html("<h5>Processing Complete! All images have been processed successfully</h5>").show();
                        }
                        localStorage.removeItem("flag");
                    } else if (batch.is_complete) {
                        statusCell.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: red;"></i>';
                        if(flag?.processingActive){
                            $("#notice-box").html("<h5>Processing Complete! Some images have failed processing</h5>").show();
                        }
                        localStorage.removeItem("flag");
                    } else if (batch.has_fail_present) {
                        statusCell.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: orange;"></i>';
                        if(flag?.processingActive){
                            $("#notice-box").html("<h5>Processing Ongoing! Some images have failed processing</h5>").show();
                        }
                        localStorage.removeItem("flag");
                    } else {
                        statusCell.innerHTML = '<i class="fas fa-spinner fa-spin" style="color: orange;"></i>';
                        $("#notice-box").html("<h5>Your images are being processed. The results are updated every 30 seconds.<br>Processing Status: <i class='fas fa-spinner fa-spin' style='color: orange;'></i></h5>").show();
                    }
                }
            })
            .catch(err => console.error(err));
    }

    // Table sorting
    document.querySelectorAll("#batchTable th").forEach((header, index) => {
        let ascending = true;
        header.addEventListener("click", () => {
            const table = header.closest("table");
            const tbody = table.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));

            rows.sort((a, b) => {
                let cellA = a.children[index].textContent.trim();
                let cellB = b.children[index].textContent.trim();

                // Try to parse numbers
                const numA = parseFloat(cellA.replace(/,/g, ""));
                const numB = parseFloat(cellB.replace(/,/g, ""));
                if (!isNaN(numA) && !isNaN(numB)) {
                    cellA = numA;
                    cellB = numB;
                }

                if (cellA < cellB) return ascending ? -1 : 1;
                if (cellA > cellB) return ascending ? 1 : -1;
                return 0;
            });

            rows.forEach(row => tbody.appendChild(row));
            ascending = !ascending;
        });
    });

    // Popup handling for table rows
    const popup = document.getElementById('popup');
    const popupText = document.getElementById('popup-text');
    const popupContent = document.querySelector('.popup-content');

    function openPopup(message) {
        popupText.textContent = message;
        popup.style.display = 'flex';
    }

    function closePopup() {
        popup.style.display = 'none';
    }

    popup.addEventListener('click', (e) => {
        if (!popupContent.contains(e.target)) closePopup();
    });

    // Click event for each batch row
    document.querySelectorAll("#batchTable tbody tr").forEach((row) => {
        row.addEventListener("click", () => {
            const batchId = row.getAttribute("data-batch-id");
            const batchName = row.children[0].textContent; // Get batch name from first column
            const popup = document.getElementById("popup");
            const popupText = document.getElementById("popup-text");
            const popupBatchName = document.getElementById("popup-batch-name");
            const editBatchBtn = document.getElementById("edit-batch-btn");
            const popupImage = document.getElementById("popup-image");
            const popupDetails = document.getElementById("popup-details");

            // Set popup header
            popup.dataset.batchId = batchId; // store batch id in popup
            popupBatchName.textContent = batchName; // update batch name text
            popupText.style.display = "inline"; 
            popup.style.display = "flex";

            // Fetch images for this batch
            fetch(`/batch/${batchId}/images/`)
                .then(res => res.json())
                .then(data => {
                    if (data.length > 0) {
                        popupImage.src = `../static/uploads/${data[0].image_name}`;
                    }

                    let rowsHTML = "";
                    data.forEach(img => {
                        rowsHTML += `
                            <tr class="image-details" 
                                data-image-name="${img.image_name}" 
                                data-image-id="${img.image_id}">
                                <td>${img.image_name}</td>
                                <td>${img.total_eggs}</td>
                                <td>${img.total_hatched}</td>
                                <td>${img.img_type}</td>
                                <td>
                                    <button class="edit-btn" 
                                        onclick="event.stopPropagation(); window.location.href='/edit/${img.image_id}'">
                                        Edit
                                    </button>
                                </td>
                                <td>
                                    <button class="delete-btn">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    popupDetails.innerHTML = rowsHTML;
                })
                .catch(err => {
                    popupText.textContent = `Error loading images for: ${batchName}`;
                    console.error(err);
                });
        });
    });


    // Change image on click inside popup
    $(document).on("click", ".image-details", function () {
    const imageName = $(this).data("image-name");
    $("#popup-image").attr("src", `../static/uploads/${imageName}`);
    });


    // Advanced filtering: search + range filters
    const inputs = [
    "batchSearch",
    "dateFrom",
    "dateTo",
    "imagesMin",
    "imagesMax",
    "eggsMin",
    "eggsMax",
    ];

    inputs.forEach(id => {
    document.getElementById(id).addEventListener("input", applyFilters);
    });

    function applyFilters() {
    const searchQuery = document.getElementById("batchSearch").value.toLowerCase();
    const dateFrom = document.getElementById("dateFrom").value ? new Date(document.getElementById("dateFrom").value) : null;
    const dateTo = document.getElementById("dateTo").value ? new Date(document.getElementById("dateTo").value) : null;
    const imagesMin = parseFloat(document.getElementById("imagesMin").value) || 0;
    const imagesMax = parseFloat(document.getElementById("imagesMax").value) || Infinity;
    const eggsMin = parseFloat(document.getElementById("eggsMin").value) || 0;
    const eggsMax = parseFloat(document.getElementById("eggsMax").value) || Infinity;

    const rows = document.querySelectorAll("#batchTable tbody tr");

    rows.forEach(row => {
        const cells = row.children;
        const batchName = cells[0].textContent.toLowerCase();
        const dateText = cells[1].textContent.trim();
        const totalImages = parseFloat(cells[2].textContent.trim()) || 0;
        const totalEggs = parseFloat(cells[3].textContent.trim()) || 0;

        // Parse date (supports MM/DD/YYYY)
        const dateParts = dateText.split('/');
        const rowDate = new Date(`${dateParts[2]}-${dateParts[0]}-${dateParts[1]}`);

        // Check filters
        const matchesName = batchName.includes(searchQuery);
        const matchesDate =
        (!dateFrom || rowDate >= dateFrom) && (!dateTo || rowDate <= dateTo);
        const matchesImages = totalImages >= imagesMin && totalImages <= imagesMax;
        const matchesEggs = totalEggs >= eggsMin && totalEggs <= eggsMax;

        // Show only rows that match all conditions
        row.style.display = matchesName && matchesDate && matchesImages && matchesEggs ? "" : "none";
    });
    }

    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", (event) => {
            event.stopPropagation(); // Prevents row click event from firing
            const batchId = btn.dataset.batchId;
            if (confirm("Are you sure you want to delete this batch?")) {
                fetch(`/delete-batch/${batchId}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken(),
                    },
                }).then(response => {
                    if (response.ok) {
                        btn.closest("tr").remove();
                    } else {
                        alert("Failed to delete batch.");
                    }
                });
            }
        });
    });

    // Sorting logic for popup table
    document.addEventListener("click", (e) => {
        if (e.target.tagName === "TH") {
            const table = e.target.closest("table");
            const tbody = table.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));
            const column = e.target.cellIndex;
            const ascending = !e.target.classList.contains("asc");

            // Remove sort icons from all headers
            table.querySelectorAll("th").forEach(th => th.classList.remove("asc", "desc"));
            e.target.classList.add(ascending ? "asc" : "desc");

            rows.sort((a, b) => {
            const valA = a.children[column].textContent.trim();
            const valB = b.children[column].textContent.trim();

            // Detect numeric sorting
            const numA = parseFloat(valA);
            const numB = parseFloat(valB);

            if (!isNaN(numA) && !isNaN(numB)) {
                return ascending ? numA - numB : numB - numA;
            } else {
                return ascending ? valA.localeCompare(valB) : valB.localeCompare(valA);
            }
            });

            // Reattach sorted rows
            rows.forEach(r => tbody.appendChild(r));
        }
    });

    // Handle delete button click inside popup
    $(document).on("click", ".popup .delete-btn", function(event) {
        event.stopPropagation(); // Prevent row click from firing
        const row = $(this).closest("tr");
        const imageId = row.data("image-id");
        const currentPreview = $("#popup-image").attr("src");
        const imageSrc = `../static/uploads/${row.data("image-name")}`;

        if (confirm("Are you sure you want to delete this image?")) {
            fetch(`/delete-image/${imageId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                },
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Remove row from popup table
                    row.remove();

                    // Update preview if it was the deleted image
                    if (currentPreview === imageSrc) {
                        const firstRow = $("#popup-details tr").first();
                        if (firstRow.length) {
                            const firstImageName = firstRow.data("image-name");
                            $("#popup-image").attr("src", `../static/uploads/${firstImageName}`);
                        } else {
                            $("#popup-image").attr("src", ""); // no images left
                        }
                    }

                    // Update main batch table or remove batch if deleted
                    if (data.batch_deleted) {
                        const batchId = row.closest(".popup").data("batch-id"); // make sure you set this attribute
                        $(`#batchTable tbody tr[data-batch-id="${batchId}"]`).remove();
                        closePopup(); // close the popup since batch is gone
                        alert("Last image deleted. Batch removed.");
                    } else {
                        // Update the total_images and total_eggs columns
                        const batchId = $("#popup").data("batch-id");
                        const batchRow = $(`#batchTable tbody tr[data-batch-id="${batchId}"]`);
                        batchRow.find("td:nth-child(3)").text(data.new_total_images); // total images
                        batchRow.find("td:nth-child(4)").text(data.new_total_eggs);   // total eggs
                    }
                } else {
                    alert("Failed to delete image: " + data.message);
                }
            })
            .catch(err => console.error(err));
        }
    });

    const popupBatchName = document.getElementById("popup-batch-name");
    const editBatchBtn = document.getElementById("edit-batch-btn");

    editBatchBtn.addEventListener("click", () => {
        const currentName = popupBatchName.textContent;
        
        // Replace text with input
        popupBatchName.innerHTML = `
            <input type="text" id="batch-name-input" value="${currentName}" />
            <span id="batch-name-edit-controls">
                <button class="save-btn">&#10003;</button>
                <button class="cancel-btn">&#10005;</button>
            </span>
        `;

        const input = document.getElementById("batch-name-input");
        const saveBtn = document.querySelector("#batch-name-edit-controls .save-btn");
        const cancelBtn = document.querySelector("#batch-name-edit-controls .cancel-btn");

        input.focus();

        // Save new name
        saveBtn.addEventListener("click", () => {
            const newName = input.value.trim();
            if (newName === "") {
                alert("Batch name cannot be empty.");
                return;
            }

            const batchId = document.getElementById("popup").dataset.batchId;

            fetch(`/edit-batch-name/${batchId}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(),
                },
                body: JSON.stringify({ batch_name: newName }),
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    popupBatchName.textContent = newName;

                    // Also update main batch table
                    const batchRow = document.querySelector(`#batchTable tbody tr[data-batch-id="${batchId}"]`);
                    batchRow.children[0].textContent = newName;
                } else {
                    alert("Failed to update batch: " + data.message);
                }
            })
            .catch(err => console.error(err));
        });

        // Cancel editing
        cancelBtn.addEventListener("click", () => {
            popupBatchName.textContent = currentName;
        });
    });






    function getCSRFToken() {
        const name = 'csrftoken';
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = $.trim(cookies[i]);
            if (cookie.startsWith(name + '=')) {
                return decodeURIComponent(cookie.substring(name.length + 1));
            }
        }
        return '';
    }



    </script>
</html>
